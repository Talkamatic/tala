node("docker && tala && linux") {
    timestamps {
        stage('prepare') {
            deleteDir()
            sh 'mkdir artifacts'

            step([
                $class: 'CopyArtifact',
                filter: 'dist/*.whl',
                fingerprintArtifacts: true,
                projectName: 'tala-latest',
                selector: [
                    $class: 'StatusBuildSelector',
                    stable: false
                ],
                target: 'artifacts'
            ])
        }

        stage('build') {
            sh '''#!/bin/bash -ex
                docker build . -t talkamatic/tala:nightly
            '''
        }

        stage('push') {
            withCredentials([[$class: 'StringBinding', credentialsId: 'dockerhubcred', variable: 'pw']]) {
                sh '''#!/bin/bash -ex
                    echo $pw | docker login -u zigit --password-stdin
                    docker push talkamatic/tala:nightly
                '''
            }
        }
    }
}
